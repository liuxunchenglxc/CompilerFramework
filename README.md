# CompilerFramework

- **开发人员**: `刘迅承`
- **依赖环境**: `.NET Core 2.1`
- **开发环境**: `Visual Studio 2017`
- **开发语言**: `C# 7.1`
- **命名空间**: `CompilerFramework`
- **详细参考**: `./CompilerFramework/CompilerFramework.xml`

## 词法部分：

**命名空间**：`CompilerFramework.Lexer`

### 基础框架类：`LexerFramework`

- **基本功能**：实现正则表达式与词法分析的桥梁。
- **基本应用**：对普通的语言进行基本的词法分析。
- **高级功能**：实现多组正则表达式分组匹配模式。
- **高级应用**：对多行注释实现词法分析，构建多重匹配分支与入口。
- **应用步骤**：先添加`LexItem`再对`TextReader`进行词法分析。
- **词法分析方式**：逐行读入逐行分析，单次匹配触发事件，持续分析。
- **词法分析结果**：从事件`OnLexedEventHandler`接收结果，并可以根据结果更改匹配组，以实现改变匹配分支。
- **词法分析异常**：
  1. 匹配组号超出预定组号，报告组号，异常类为`GroupNumException`
  2. 匹配失败，报告失败位置，异常类为`NoMatchException`
  3. 零长度匹配，会引起死循环，报告具体的`LexItem`内容，异常类为`ZeroLenghtMatchException`
- **词法分析最小单位**：结构体`LexItem`
  1. 名称：便于语法分析与分类
  2. 正则表达式：匹配法则，自动在表达式最前方添加`^`
  3. 正则表达式匹配模式：默认不使用特殊模式
  4. 匹配结果文本处理委托：用于对文本结果的处理
- **词法分析结果最小单位**：结构体`LexerResult`
  1. 次序：便于计次与异步处理
  2. 名称：与结构体`LexItem`的名称一致
  3. 值：经过用户处理后或默认`string`内容不变，类型为`object`的结果
  4. 位置：词法项出现的位置，用于下一步语法分析的报错信息等。
- **词法分析计数方式**：根据事件返回值判断是否计数，如果返回真则计数，且判定为“接受的结果”，可送入语法分析。特别的，如果匹配结果经过处理后为空，则不触发事件，不计数。
- **输入流**：输入选择`TextReader`类，其派生类`StringReader`可接收字符串流，`StreamReader`可接收文件流。适配最常用的两种输入类型。
- **语法分析桥梁**：事件`OnAcceptedEventHandler`，其中的`LexerResult`均为“接受的结果”，并已经按顺序连续计数。在此事件中请调用语法分析相关函数，比如`ParseLexUnit`或`ParseLexUnitAsync`。
- **语法分析结束**：方法`LexStream`返回值即为“接受的结果”的总数，可以作为语法分析中词法分析结果传入结束标志的组成之一，并在方法返回后调用相关函数以告知语法分析部分传入结束了。此外，事件`OnFinishedEventHandler`同样提供了“接受的结果”的总数，并可以调用相关函数以通知语法分析部分。两种方法皆可。

### 派生框架类：`HLlangLexerFramework`

- **基本功能**：封装高级编程语言的词法分析项
- **基本应用**：更容易，代码更少的创建词法分析器
- **高级功能**：分组匹配时，匹配组的批量添加
- **高级应用**：更容易，代码更少的实现多组匹配词法分析器
- **词法分析封装**：
  1. **添加保留字**：批量添加，自动在正则表达式末尾添加零宽断言`(?=\W|$)`
  2. **添加标识符**：默认规则为`[A-Za-z]\w*`
  3. **添加运算符**：批量添加，无特殊处理
  4. **添加界符**：批量添加，无特殊处理
  5. **添加常项**：批量添加，可选自动在正则表达式末尾添加零宽断言`(?=\W|$)`
  6. **常用转换委托**

## 语法部分：

**命名空间**：`CompilerFramework.Parser`

### 基础框架类：`ParserFramework`

- **基本功能**：实现词法分析结果与语法分析的桥梁，并实现最基本的语法分析框架定义。
- **基本应用**：通过对此类的派生，对普通语言的词法分析结果进行基本的语法分析。
- **语法分析准备阶段**：
  - **同步方法**：`ParseLexUnit`，此方法会直到相关语法分析阶段性结束后（比如归约移进后，或预测表分析后）才返回，然后语法分析等待读入下一个词法分析结果。
  - **异步机制**：类`ParseDoor`专门用于控制多线程同步，此类中实例化为`door`对象。通过`door.Index`的判断与`lock (door)`配合来实现异步下的词法分析结果输入。
  - **异步方法**：`ParseLexUnitAsync`，此方法会将词法分析结果加入await关键字下的方法中，之后词法分析结果们会排队传入语法分析部分。具体排队方法为判断当前的`door.Index`是否等于自己的Index，如果小于则继续等待，如果等于则锁住`door`，开始语法分析。判断使用while循环，因为lock后会阻塞一切while判断，当阻塞消失时，只有相应的词法分析结果才能进入，这样既不会导致过多while判断而死掉，也不会带来额外的内存空间及其管理代码。
- **语法分析准备阶段异常**：
  1. （同步与异步）传入的词法分析结果不是按照顺序的。异步方法要求顺序调用，以保证不缺补漏。报告传入的词法分析结果的`Index`与应当传入的`Index`项，异常类为`ParseIndexException`。
  2. （异步）异步机制出现异常，应当进入语法分析的项没有进入，此异常一般情况下不应该发生，除非有代码逻辑错误。报告没有传入项的`Index`与欲接收的`Index`,异常类为`AsyncIndexException`。
